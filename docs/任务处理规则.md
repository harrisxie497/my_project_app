2.1 系统整体处理流程（统一）
用户上传 Excel
   ↓
解析源文件（file_definitions）
   ↓
按 field_pipelines 顺序处理每一列
   ↓
每一列按 pipeline_steps_json 执行
   ↓
执行 check_rules_json
   ↓
任一失败 → 阻断 + 错误提示
   ↓
全部成功 → 生成结果 Excel

2.1 规则类型体系说明（必须读）

本系统所有字段的生成，统一抽象为“规则（Rule）”。
规则分为 6 类，每一类都有明确职责边界，避免混乱。

2.1.1 规则类型总览
rule_type	中文名称	是否引入新信息	是否依赖其他列	常见场景
CONST	常量规则	❌	❌	固定值字段
COPY	复制规则	❌	❌	原样映射
FORMAT	格式化规则	❌	可选	去符号、日期格式
CALC	计算规则	❌	✅	价格、汇率
AI	AI 生成规则	✅	✅	翻译、生成、推断
RULE_FIX	校验修正规则	❌	❌	校验 + 自动修正
2.1.2 各类规则详细说明 + 样例
【CONST】常量规则

定义

直接生成一个固定值

完全不依赖源文件

适用场景

清关固定值（DIDA、JPY、CN）

业务强约束字段

示例

{
  "rule_ref": "R_CONST_DIDA",
  "rule_type": "CONST",
  "executor_type": "program",
  "schema_json": {
    "value": "DIDA"
  }
}


执行语义

不看源数据，直接返回 DIDA

【COPY】复制规则

定义

原样复制源字段

不引入新信息

示例

{
  "rule_ref": "R_COPY",
  "rule_type": "COPY",
  "executor_type": "program",
  "schema_json": {}
}


执行语义

target = source

【FORMAT】格式化规则

定义

对已有值做格式调整

不改变语义

常见子类型

去 -

大小写

日期格式

示例：日期格式化

{
  "rule_ref": "R_DATE_FORMAT",
  "rule_type": "FORMAT",
  "executor_type": "program",
  "schema_json": {
    "input_formats": ["YYYY/MM/DD", "YYYY-MM-DD"],
    "output_format": "YYYY-MM-DD"
  }
}

【CALC】计算规则

定义

数值计算

依赖多个字段

示例：清关价格计算

{
  "rule_ref": "R_CALC_INVOICE_PRICE",
  "rule_type": "CALC",
  "executor_type": "web",
  "schema_json": {
    "formula": "unit_price * qty * fx_rate",
    "fx_api": "JPY_RATE"
  }
}

【AI】AI 生成规则（最重要）

定义

引入新信息

基于上下文语义生成结果

典型能力

翻译

信息提取

多字段生成

合规化重写

示例：品名翻译

{
  "rule_ref": "R_AI_ITEM_NAME",
  "rule_type": "AI",
  "executor_type": "ai",
  "schema_json": {
    "task": "translate_and_clean",
    "from_lang": "jp",
    "to_lang": "en",
    "requirements": [
      "uppercase",
      "no_parentheses",
      "ascii_only"
    ]
  }
}

【RULE_FIX】校验修正规则

定义

对字段进行校验

可自动修正（或失败阻断）

示例

{
  "rule_ref": "R_FIX_PHONE",
  "rule_type": "RULE_FIX",
  "executor_type": "program",
  "schema_json": {
    "remove_chars": ["-"],
    "regex": "^0\\d{10}$",
    "on_fail": "block"
  }
}

2.2 字段 Pipeline 执行模型（理解这一节=理解系统）

每一个字段 = 一个 Pipeline

Pipeline 的三部分：

source_refs：输入上下文

pipeline_steps：生成/处理规则（顺序）

check_rules：最终校验

Pipeline 示例（典型）
{
  "source_refs": [{"file":"SRC","col":"K"}],
  "pipeline_steps": [
    {"order":10,"rule_ref":"R_AI_TRANSLATE","apply_policy":"STOP_ON_SUCCESS"},
    {"order":20,"rule_ref":"R_FORMAT_UPPER","apply_policy":"CONTINUE"}
  ],
  "check_rules": {
    "required": true
  }
}

2.3 清关文件（版本B）字段转换说明（A–AH 全量）

这是给配置人员 & 业务确认用的表
每一列的来源、规则、校验都写清楚。

清关字段转换总表（节选，示例）
列	字段名	来源	规则类型	转换逻辑说明
A	会员编号	CONST	CONST	固定写入 DIDA
B	序号	系统	CALC	从 1 连续递增
C	HAWB番号	SRC.C	COPY	原样复制
D	現地問合せ番号	RESULT.C	COPY	等于 C
E	貨物個数	CONST	CONST	固定 1
F	貨物重量	SRC.H/I	AI	基于品名材质 AI 推断
G	重量単位	CONST	CONST	KGM
H	品名	SRC.H	AI	日文→英文→清洗
I	材质	SRC.I	AI	翻译 + 材质置换
J	輸入者名	SRC.K	AI	日文→英文
K	輸入者住所	SRC.P	AI	日文地址→英文
L	郵便番号	SRC.Q	FORMAT	去 "-"
M	電話番号	SRC.R	FORMAT	去 "-"
N	輸出者名	CONST	CONST	固定公司名
O	輸出者住所	CONST	CONST	固定地址
P	条件コード	CONST	CONST	C&F
Q	通貨コード	CONST	CONST	JPY
R	インボイス価格	SRC.X + FX	CALC	汇率×单价
…	…	…	…	…
AG	平台码	SRC.AM	CALC	搜索或默认
AH	平台名	AG	CALC	由码映射

（👉 如果你需要，我可以下一步把这张表 完整列到 AH）

2.4 派送文件字段转换说明（摘要）

派送文件相对简单，绝大多数字段属于 COPY / FORMAT / DEFAULT。

派送典型字段说明
列	字段	规则
A	お客様管理番号	COPY
C	配達指定日	FORMAT（YYYY-MM-DD）
D	時間帯指定	RULE_FIX（依赖 C 是否为空）
J	依頼主	DEFAULT（空→DIDA）
K	依頼主住所	DEFAULT
Q	記事欄3	RULE_FIX（空→复制 A）
R–Y	删除字段	CONST 空