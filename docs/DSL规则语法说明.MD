非常好，这一步你选得**非常专业** 👍
下面我给你的是一份 **可以直接保存、纳入你项目文档体系的《规则表达式 DSL 规范 v1.0》**。

这份文档的目标不是“炫技”，而是 **长期可维护 + 可审计 + 可被非程序员理解**。

你可以直接把它保存成：

* `docs/rule_dsl_spec.md`
* 或放进 Confluence / Wiki
* 或作为“配置评审必读文档”

---

# 规则表达式 DSL 规范（v1.0）

**适用范围**

* 派送文件 / 清关文件的字段处理规则
* 适用于 `FORMAT / DEFAULT / CALC / RULE_FIX` 类型
* 不适用于 AI 字段（AI 使用单独配置）

---

## 1. 设计目标

本 DSL 用于描述 **Excel 字段处理规则**，满足以下目标：

* ✅ 人类一眼能读懂（接近业务语言）
* ✅ 机器可安全解析（不使用 eval）
* ✅ 表达能力刚好够用（不引入完整编程）
* ✅ 规则可审计、可回放
* ✅ 未来可扩展（v2/v3）

---

## 2. DSL 使用位置（非常重要）

DSL **只允许出现在**：

```text
rule_items.proc_rules
```

且仅当：

```text
field_type ∈ {FORMAT, DEFAULT, CALC, RULE_FIX}
executor_type = program
```

---

## 3. DSL 的基本结构

```json
{
  "transformation_type": "conditional_expr",
  "target_col": "D",
  "rules": [
    {
      "when": "<条件表达式>",
      "set": "<赋值表达式>"
    }
  ],
  "else": "KEEP"
}
```

---

## 4. 条件表达式（WHEN）

### 4.1 基本语法

```text
<expr> ::= <term> ( (&& | ||) <term> )*
<term> ::= <operand> (== | !=) <operand>
```

---

### 4.2 操作数（operand）

#### 列引用

* 使用 Excel 列字母

```text
A, B, C, D, ... Z, AA, AB
```

#### 常量

* 字符串：`'00'`, `''`
* 数字：`0`, `1`, `12`

---

### 4.3 支持的运算符（v1.0）

| 类型 | 运算符  | 示例                  |   |         |   |           |
| -- | ---- | ------------------- | - | ------- | - | --------- |
| 比较 | `==` | `D == 0`            |   |         |   |           |
| 比较 | `!=` | `C != ''`           |   |         |   |           |
| 逻辑 | `&&` | `C != '' && D == 0` |   |         |   |           |
| 逻辑 | `    |                     | ` | `D == 0 |   | D == '0'` |

> ❗ v1.0 **不支持** `>` `<` `>=` `in` `regex`

---

### 4.4 空值语义（强制约定）

* `''`：表示“空字符串 / 空单元格”
* 数字 `0` 与字符串 `'0'` **不等价**，需显式写出

示例：

```text
D == 0 || D == '0'
```

---

## 5. 赋值表达式（SET）

### 5.1 支持类型

| 类型  | 写法     | 含义     |
| --- | ------ | ------ |
| 字符串 | `"00"` | 设置为字符串 |
| 空   | `""`   | 设置为空   |
| 特殊  | `KEEP` | 保持原值   |

---

### 5.2 赋值规则

* 命中某条 `when` 后：

  * 立即执行 `set`
  * **不再继续匹配后续规则**
* 若无任何规则命中：

  * 执行 `else`（如存在）
  * 否则默认 `KEEP`

---

## 6. 执行顺序（确定性保证）

```text
for rule in rules (按配置顺序):
    if rule.when 为真:
        执行 rule.set
        break
else:
    执行 else
```

> 配置顺序即执行顺序，**不得自动重排**

---

## 7. 示例（D 列标准规则）

```json
{
  "transformation_type": "conditional_expr",
  "target_col": "D",
  "rules": [
    {
      "when": "C != '' && (D == 0 || D == '0')",
      "set": "00"
    },
    {
      "when": "C == '' && (D == 0 || D == '0')",
      "set": ""
    }
  ],
  "else": "KEEP"
}
```

**业务解释：**

* 有派送日期时，时间段 0 → 00
* 无派送日期时，时间段 0 → 空
* 其他情况不变

---

## 8. 校验规则（导入时强制）

配置导入时必须校验：

* `when` 中的列必须 ∈ `depends_on`
* 不允许出现未知运算符
* 不允许出现函数调用
* 不允许出现 Python 关键字
* `set` 只能是字符串 / 空 / KEEP

---

## 9. 明确禁止的行为 ❌

* ❌ 使用 Python / JS 表达式
* ❌ 使用 eval / exec
* ❌ 在 DSL 中修改多个列
* ❌ 在 DSL 中访问系统变量
* ❌ 在 DSL 中写循环

---

## 10. 与 AI 规则的边界

| 类型    | 使用 DSL | 使用 AI |
| ----- | ------ | ----- |
| 格式化   | ✅      | ❌     |
| 空值修复  | ✅      | ❌     |
| 依赖列计算 | ✅      | ❌     |
| 语义理解  | ❌      | ✅     |
| 内容生成  | ❌      | ✅     |

---

## 11. 版本演进建议（不现在做）

* v2：支持 `IN (...)`
* v3：支持 `REGEX_MATCH`
* v4：支持数值比较 `> <`

> **v1.0 不要超范围实现，稳定第一。**

---

## 12. 官方原则（建议写进 PRD）

> **规则 DSL 是声明式配置，不是脚本语言；
> 表达能力受控，是系统稳定性的保障。**

---

如果你愿意，下一步我可以继续帮你做一件**非常工程化**的事：

* 👉 **直接给你一份 DSL 解析器的 Python 实现（安全、可单测）**
* 👉 或把 **现有派送规则全部用 DSL 形式“重写一遍”并校验一致性**

你选哪一个，我继续。
