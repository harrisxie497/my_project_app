<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ—¥æœ¬æ¸…å…³/æ´¾é€ Excel è‡ªåŠ¨å¤„ç†ç³»ç»Ÿ - åŸå‹</title>

  <!-- Vue 3 + Element Plus (CDN prototype) -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css" />
  <script src="https://unpkg.com/element-plus/dist/index.full.min.js"></script>

  <style>
    :root { --bg: #f6f7fb; }
    body { margin: 0; background: var(--bg); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; }
    .app-shell { height: 100vh; display: flex; flex-direction: column; }
    .topbar { display:flex; align-items:center; justify-content:space-between; padding: 12px 16px; background:#ffffff; border-bottom: 1px solid #eaecef; }
    .brand { display:flex; align-items:center; gap:10px; }
    .brand-badge { width: 28px; height: 28px; border-radius: 10px; background: #2f54eb; }
    .brand-title { font-weight: 700; }
    .content { flex: 1; display:flex; min-height: 0; }
    .sidebar { width: 240px; background:#fff; border-right:1px solid #eaecef; padding: 10px; }
    .main { flex: 1; padding: 16px; overflow:auto; }
    .card { background:#fff; border:1px solid #eaecef; border-radius: 14px; }
    .card-hd { padding: 14px 14px 0 14px; display:flex; align-items:center; justify-content:space-between; gap: 12px; }
    .card-bd { padding: 14px; }
    .muted { color:#6b7280; }
    .kpi { display:grid; grid-template-columns: repeat(5, minmax(0, 1fr)); gap: 12px; }
    .kpi .box { padding: 12px; border-radius: 12px; border: 1px solid #eaecef; background: #fff; }
    .kpi .label { font-size: 12px; color:#6b7280; }
    .kpi .value { font-weight: 800; font-size: 18px; margin-top: 4px; }
    .split { display:grid; grid-template-columns: 1.25fr 0.75fr; gap: 12px; }
    .tag-pill { display:inline-flex; align-items:center; gap:6px; padding: 2px 10px; border-radius: 999px; border:1px solid #eaecef; background:#fff; font-size: 12px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .footer-note { font-size: 12px; color:#6b7280; margin-top: 10px; }
    .login-wrap { height: 100vh; display:flex; align-items:center; justify-content:center; padding: 16px; }
    .login-card { width: 980px; max-width: 100%; display:grid; grid-template-columns: 1.2fr 0.8fr; overflow:hidden; border-radius: 18px; border: 1px solid #eaecef; background:#fff; }
    .login-left { padding: 28px; background: linear-gradient(135deg, #2f54eb 0%, #1f1f1f 120%); color: #fff; }
    .login-left h1 { margin: 0 0 6px; font-size: 22px; }
    .login-left p { margin: 0; opacity: .9; }
    .login-right { padding: 28px; }
    .section-title { font-weight: 800; margin: 0 0 10px; }
    .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .danger-box { border: 1px dashed #f56c6c; padding: 10px; border-radius: 12px; background: #fff5f5; color: #b42318; }
    @media (max-width: 980px) {
      .login-card { grid-template-columns: 1fr; }
      .sidebar { display:none; }
      .split { grid-template-columns: 1fr; }
      .kpi { grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>

<body>
<div id="app"></div>

<script>
const { createApp, reactive, ref, computed } = Vue;

createApp({
  setup() {
    // ----- Mock auth state -----
    const auth = reactive({
      loggedIn: false,
      token: "",
      user: { id: "u_123", username: "admin", display_name: "Admin", role: "admin" }
    });

    // ----- Global UI state -----
    const route = ref("tasks"); // tasks | task_detail | admin_rules | admin_templates | admin_ai | admin_users | admin_logs
    const activeTaskId = ref("t_001");

    // ----- Mock data -----
    const tasks = ref([
      { id: "t_001", file_type: "customs", unique_code: "UC001", flight_no: "NH123", declare_date: "2026-01-20", status: "success", created_at: "2026-01-20T01:02:03Z" },
      { id: "t_002", file_type: "delivery", unique_code: "UC002", flight_no: "", declare_date: "", status: "failed", created_at: "2026-01-20T02:10:11Z" },
      { id: "t_003", file_type: "customs", unique_code: "UC003", flight_no: "JL777", declare_date: "2026-01-19", status: "processing", created_at: "2026-01-20T03:33:09Z" },
    ]);

    const taskDetail = computed(() => {
      const t = tasks.value.find(x => x.id === activeTaskId.value) || tasks.value[0];
      return {
        ...t,
        progress_stage: t.status === "processing" ? "fill" : (t.status === "success" ? "done" : "failed"),
        stats: t.status === "success" ? {
          total_rows: 120, fixed_count: 86, filled_count: 42, fx_changed_rows: 120, llm_filled_count: 15
        } : null,
        error: t.status === "failed" ? {
          code: "RULE_VALIDATION_FAILED",
          message: "å­—æ®µAä¸ç¬¦åˆ12ä½æ•°å­—è¦æ±‚",
          detail: { sheet: "Sheet1", row: 23, col: "A" }
        } : null
      };
    });

    // ----- Filters -----
    const filters = reactive({
      file_type: "",
      status: "",
      unique_code: ""
    });

    const filteredTasks = computed(() => {
      return tasks.value.filter(t => {
        if (filters.file_type && t.file_type !== filters.file_type) return false;
        if (filters.status && t.status !== filters.status) return false;
        if (filters.unique_code && !String(t.unique_code).includes(filters.unique_code)) return false;
        return true;
      });
    });

    // ----- Create task dialog -----
    const createDialog = ref(false);
    const createForm = reactive({
      file_type: "customs",
      unique_code: "",
      flight_no: "",
      declare_date: "",
      file: null
    });

    const handleFileChange = (file) => { createForm.file = file; };

    const submitCreate = () => {
      // prototype: add a mock task
      const id = "t_" + String(Math.floor(Math.random() * 9000 + 1000));
      tasks.value.unshift({
        id,
        file_type: createForm.file_type,
        unique_code: createForm.unique_code || "UC_NEW",
        flight_no: createForm.file_type === "customs" ? (createForm.flight_no || "NH000") : "",
        declare_date: createForm.file_type === "customs" ? (createForm.declare_date || "2026-01-20") : "",
        status: "queued",
        created_at: new Date().toISOString()
      });
      createDialog.value = false;
      activeTaskId.value = id;
      route.value = "task_detail";
      ElementPlus.ElMessage.success("å·²åˆ›å»ºä»»åŠ¡ï¼ˆåŸå‹æ¨¡æ‹Ÿï¼‰");
    };

    const runTask = () => {
      const idx = tasks.value.findIndex(t => t.id === activeTaskId.value);
      if (idx >= 0) {
        tasks.value[idx].status = "processing";
        ElementPlus.ElMessage.info("å¼€å§‹å¤„ç†ï¼ˆåŸå‹æ¨¡æ‹Ÿï¼‰");
        // simulate finish
        setTimeout(() => {
          tasks.value[idx].status = "success";
          ElementPlus.ElMessage.success("å¤„ç†å®Œæˆï¼ˆåŸå‹æ¨¡æ‹Ÿï¼‰");
        }, 800);
      }
    };

    // ----- Admin mock data -----
    const ruleTables = ref([
      { id: "rt_1", code: "MAP_CUSTOMS", file_type: "customs", rule_stage: "MAP", enabled: true, description: "åŸå§‹â†’æœ€ç»ˆå­—æ®µæ˜ å°„ï¼ˆæ¸…å…³ï¼‰" },
      { id: "rt_2", code: "PROCESS_CUSTOMS", file_type: "customs", rule_stage: "PROCESS", enabled: true, description: "æœ€ç»ˆæ–‡ä»¶å­—æ®µæ ¡éªŒ/ä¿®æ­£/ç”Ÿæˆï¼ˆæ¸…å…³ï¼‰" },
      { id: "rt_3", code: "MAP_DELIVERY", file_type: "delivery", rule_stage: "MAP", enabled: true, description: "åŸå§‹â†’æœ€ç»ˆå­—æ®µæ˜ å°„ï¼ˆæ´¾é€ï¼‰" },
      { id: "rt_4", code: "PROCESS_DELIVERY", file_type: "delivery", rule_stage: "PROCESS", enabled: true, description: "æœ€ç»ˆæ–‡ä»¶å­—æ®µæ ¡éªŒ/ä¿®æ­£/ç”Ÿæˆï¼ˆæ´¾é€ï¼‰" },
    ]);

    const templateMappings = ref([
      { id: "tm_1", mapping_code: "TM_CUSTOMS_V1", file_type: "customs", sheet_match_mode: "name", sheet_match_value: "Sheet1", enabled: true },
      { id: "tm_2", mapping_code: "TM_DELIVERY_V1", file_type: "delivery", sheet_match_mode: "name", sheet_match_value: "Sheet1", enabled: true },
    ]);

    const aiCaps = ref([
      { id: "aic_1", file_type: "customs", target_column: "B", capability_code: "JP_NAME_FILL", depends_on: "B,C,D,E", on_fail: "block", enabled: true },
      { id: "aic_2", file_type: "customs", target_column: "F", capability_code: "JP_PRODUCT_DESC_FILL", depends_on: "C,D,E", on_fail: "block", enabled: true },
    ]);

    const users = ref([
      { id: "u_123", username: "admin", display_name: "Admin", role: "admin", enabled: true },
      { id: "u_200", username: "op1", display_name: "æ“ä½œå‘˜1", role: "operator", enabled: true },
    ]);

    const logs = ref([
      { id: "log_1", created_at: "2026-01-20T01:02:03Z", user: "admin", action: "TASK_CREATED", entity: "task:t_001", success: true, message: "created" },
      { id: "log_2", created_at: "2026-01-20T01:02:20Z", user: "admin", action: "TASK_SUCCEEDED", entity: "task:t_001", success: true, message: "success" },
      { id: "log_3", created_at: "2026-01-20T02:10:11Z", user: "op1", action: "TASK_FAILED", entity: "task:t_002", success: false, message: "RULE_VALIDATION_FAILED" },
    ]);

    // ----- Login form -----
    const loginForm = reactive({ username: "admin", password: "123456" });
    const doLogin = () => {
      if (!loginForm.username || !loginForm.password) {
        ElementPlus.ElMessage.error("è¯·è¾“å…¥è´¦å·å¯†ç ");
        return;
      }
      auth.loggedIn = true;
      auth.token = "mock-jwt";
      auth.user.username = loginForm.username;
      auth.user.role = loginForm.username === "admin" ? "admin" : "operator";
      ElementPlus.ElMessage.success("ç™»å½•æˆåŠŸï¼ˆåŸå‹ï¼‰");
    };

    const doLogout = () => {
      auth.loggedIn = false;
      auth.token = "";
      route.value = "tasks";
    };

    const menuItems = computed(() => {
      const base = [
        { key: "tasks", label: "ä»»åŠ¡ä¸­å¿ƒ", icon: "ğŸ“„" }
      ];
      if (auth.user.role === "admin") {
        base.push(
          { key: "admin_rules", label: "è§„åˆ™é…ç½®", icon: "ğŸ§©" },
          { key: "admin_templates", label: "æ¨¡æ¿æ˜ å°„", icon: "ğŸ—‚ï¸" },
          { key: "admin_ai", label: "AI èƒ½åŠ›é…ç½®", icon: "ğŸ¤–" },
          { key: "admin_users", label: "ç”¨æˆ·ç®¡ç†", icon: "ğŸ‘¤" },
          { key: "admin_logs", label: "æ“ä½œæ—¥å¿—", icon: "ğŸ§¾" },
        );
      }
      return base;
    });

    const goTaskDetail = (id) => { activeTaskId.value = id; route.value = "task_detail"; };

    // Download prototype (just toast)
    const downloadFile = (kind) => {
      ElementPlus.ElMessage.success(`ä¸‹è½½ ${kind}ï¼ˆåŸå‹æ¨¡æ‹Ÿï¼‰`);
    };

    // Import prototype
    const importDialog = ref(false);
    const importFile = ref(null);
    const onImportChange = (file) => { importFile.value = file; };
    const doImport = () => {
      importDialog.value = false;
      ElementPlus.ElMessage.success("å¯¼å…¥å®Œæˆï¼ˆåŸå‹æ¨¡æ‹Ÿï¼‰");
    };

    return {
      auth, route, menuItems,
      tasks, filters, filteredTasks,
      createDialog, createForm, handleFileChange, submitCreate,
      activeTaskId, taskDetail, goTaskDetail, runTask,
      ruleTables, templateMappings, aiCaps, users, logs,
      loginForm, doLogin, doLogout,
      downloadFile,
      importDialog, onImportChange, doImport
    };
  },

  template: `
  <div>
    <!-- LOGIN -->
    <div v-if="!auth.loggedIn" class="login-wrap">
      <div class="login-card">
        <div class="login-left">
          <div class="brand">
            <div class="brand-badge"></div>
            <div>
              <div class="brand-title">æ—¥æœ¬æ¸…å…³/æ´¾é€ Excel è‡ªåŠ¨å¤„ç†ç³»ç»Ÿ</div>
              <div class="muted" style="color: rgba(255,255,255,.85); font-size: 12px;">åŸå‹ Demoï¼ˆVue3 + Element Plusï¼‰</div>
            </div>
          </div>
          <div style="margin-top: 18px;">
            <h1>ä¸€ç«™å¼ä¸Šä¼  â†’ ä¿®å¤/è¡¥é½ â†’ ä¸‹è½½</h1>
            <p>æ”¯æŒæ¸…å…³æ–‡ä»¶ / æ´¾é€æ–‡ä»¶ Â· è§„åˆ™é©±åŠ¨ Â· AI å­—æ®µè¡¥é½ Â· è¾“å‡ºå¯¹æ¯”ä¸ç»Ÿè®¡</p>
          </div>
          <div style="margin-top: 18px;" class="danger-box">
            åŸå‹æç¤ºï¼šè¯¥é¡µé¢æ— çœŸå®åç«¯ï¼Œä»…ç”¨äºç¡®è®¤é¡µé¢ç»“æ„ä¸äº¤äº’æµç¨‹ã€‚
          </div>
        </div>
        <div class="login-right">
          <div class="section-title">ç™»å½•</div>
          <el-form label-position="top">
            <el-form-item label="è´¦å·">
              <el-input v-model="loginForm.username" placeholder="è¯·è¾“å…¥è´¦å·"></el-input>
            </el-form-item>
            <el-form-item label="å¯†ç ">
              <el-input v-model="loginForm.password" placeholder="è¯·è¾“å…¥å¯†ç " show-password></el-input>
            </el-form-item>
            <el-button type="primary" style="width: 100%;" @click="doLogin">ç™»å½•</el-button>
            <div class="footer-note">ç™»å½•åå¯è®¿é—®ä»»åŠ¡ä¸­å¿ƒï¼›ç®¡ç†å‘˜å¯è¿›å…¥é…ç½®ä¸­å¿ƒã€‚</div>
          </el-form>
        </div>
      </div>
    </div>

    <!-- APP -->
    <div v-else class="app-shell">
      <div class="topbar">
        <div class="brand">
          <div class="brand-badge"></div>
          <div>
            <div class="brand-title">æ—¥æœ¬æ¸…å…³/æ´¾é€ Excel è‡ªåŠ¨å¤„ç†ç³»ç»Ÿ</div>
            <div class="muted" style="font-size: 12px;">
              å½“å‰ç”¨æˆ·ï¼š<span class="mono">{{auth.user.username}}</span> Â· è§’è‰²ï¼š<span class="mono">{{auth.user.role}}</span>
            </div>
          </div>
        </div>
        <div style="display:flex; gap: 8px; align-items:center;">
          <el-button @click="route='tasks'">ä»»åŠ¡ä¸­å¿ƒ</el-button>
          <el-button type="danger" plain @click="doLogout">é€€å‡º</el-button>
        </div>
      </div>

      <div class="content">
        <div class="sidebar">
          <el-menu :default-active="route" @select="(k)=>route=k" style="border-right: none;">
            <el-menu-item v-for="m in menuItems" :key="m.key" :index="m.key">
              <span style="margin-right:8px;">{{m.icon}}</span>
              <span>{{m.label}}</span>
            </el-menu-item>
          </el-menu>
          <div class="footer-note">
            åŸå‹ï¼šä¾§è¾¹æ éšè§’è‰²å˜åŒ–ã€‚ä¸‹è½½ä¸åšé¢å¤–é‰´æƒï¼ˆä»…ç™»å½•ï¼‰ã€‚
          </div>
        </div>

        <div class="main">
          <!-- TASK LIST -->
          <div v-if="route==='tasks'" class="card">
            <div class="card-hd">
              <div>
                <div class="section-title">ä»»åŠ¡ä¸­å¿ƒ</div>
                <div class="muted">ä¸Šä¼  1 ä¸ª Excel â†’ ç”Ÿæˆç»“æœ Excelã€å¯¹æ¯”æ–‡ä»¶ã€å˜åŒ–ç»Ÿè®¡</div>
              </div>
              <div style="display:flex; gap:8px;">
                <el-button type="primary" @click="createDialog=true">æ–°å»ºä»»åŠ¡</el-button>
              </div>
            </div>

            <div class="card-bd">
              <div class="grid-2" style="margin-bottom: 10px;">
                <el-select v-model="filters.file_type" placeholder="æ–‡ä»¶ç±»å‹ï¼ˆå…¨éƒ¨ï¼‰" clearable>
                  <el-option label="æ¸…å…³æ–‡ä»¶" value="customs"></el-option>
                  <el-option label="æ´¾é€æ–‡ä»¶" value="delivery"></el-option>
                </el-select>

                <el-select v-model="filters.status" placeholder="çŠ¶æ€ï¼ˆå…¨éƒ¨ï¼‰" clearable>
                  <el-option label="queued" value="queued"></el-option>
                  <el-option label="processing" value="processing"></el-option>
                  <el-option label="success" value="success"></el-option>
                  <el-option label="failed" value="failed"></el-option>
                </el-select>

                <el-input v-model="filters.unique_code" placeholder="å”¯ä¸€ç¼–ç ï¼ˆæ¨¡ç³ŠåŒ¹é…ï¼‰"></el-input>
                <div></div>
              </div>

              <el-table :data="filteredTasks" style="width:100%;" @row-click="(row)=>goTaskDetail(row.id)">
                <el-table-column prop="id" label="ä»»åŠ¡ID" width="120"></el-table-column>
                <el-table-column prop="file_type" label="ç±»å‹" width="120">
                  <template #default="{row}">
                    <span class="tag-pill">{{ row.file_type==='customs' ? 'æ¸…å…³' : 'æ´¾é€' }}</span>
                  </template>
                </el-table-column>
                <el-table-column prop="unique_code" label="å”¯ä¸€ç¼–ç " width="140"></el-table-column>
                <el-table-column prop="flight_no" label="èˆªç©ºå·" width="120"></el-table-column>
                <el-table-column prop="declare_date" label="æŠ¥å…³æ—¥æœŸ" width="120"></el-table-column>
                <el-table-column prop="status" label="çŠ¶æ€" width="120">
                  <template #default="{row}">
                    <el-tag v-if="row.status==='success'" type="success">success</el-tag>
                    <el-tag v-else-if="row.status==='failed'" type="danger">failed</el-tag>
                    <el-tag v-else-if="row.status==='processing'" type="warning">processing</el-tag>
                    <el-tag v-else>queued</el-tag>
                  </template>
                </el-table-column>
                <el-table-column prop="created_at" label="åˆ›å»ºæ—¶é—´"></el-table-column>
              </el-table>

              <div class="footer-note">
                ç‚¹å‡»ä»»æ„è¡Œè¿›å…¥ä»»åŠ¡è¯¦æƒ…ã€‚åŸå‹ä¸­ä¸‹è½½/è¿è¡Œå‡ä¸ºæ¨¡æ‹Ÿã€‚
              </div>
            </div>
          </div>

          <!-- TASK DETAIL -->
          <div v-else-if="route==='task_detail'" class="split">
            <div class="card">
              <div class="card-hd">
                <div>
                  <div class="section-title">ä»»åŠ¡è¯¦æƒ…</div>
                  <div class="muted">ä»»åŠ¡IDï¼š<span class="mono">{{taskDetail.id}}</span></div>
                </div>
                <div style="display:flex; gap:8px;">
                  <el-button @click="route='tasks'">è¿”å›åˆ—è¡¨</el-button>
                  <el-button type="primary" :disabled="taskDetail.status==='processing'" @click="runTask">è¿è¡Œä»»åŠ¡</el-button>
                </div>
              </div>

              <div class="card-bd">
                <div style="display:flex; gap:10px; flex-wrap: wrap; margin-bottom: 12px;">
                  <span class="tag-pill">ç±»å‹ï¼š{{taskDetail.file_type==='customs'?'æ¸…å…³':'æ´¾é€'}}</span>
                  <span class="tag-pill">å”¯ä¸€ç¼–ç ï¼š<span class="mono">{{taskDetail.unique_code}}</span></span>
                  <span v-if="taskDetail.file_type==='customs'" class="tag-pill">èˆªç©ºå·ï¼š<span class="mono">{{taskDetail.flight_no}}</span></span>
                  <span v-if="taskDetail.file_type==='customs'" class="tag-pill">æŠ¥å…³æ—¥æœŸï¼š<span class="mono">{{taskDetail.declare_date}}</span></span>
                  <span class="tag-pill">çŠ¶æ€ï¼š
                    <el-tag v-if="taskDetail.status==='success'" type="success">success</el-tag>
                    <el-tag v-else-if="taskDetail.status==='failed'" type="danger">failed</el-tag>
                    <el-tag v-else-if="taskDetail.status==='processing'" type="warning">processing</el-tag>
                    <el-tag v-else>queued</el-tag>
                  </span>
                </div>

                <el-divider />

                <div class="section-title" style="margin-bottom: 8px;">æ–‡ä»¶ä¸‹è½½</div>
                <div style="display:flex; gap:8px; flex-wrap: wrap;">
                  <el-button @click="downloadFile('original')">ä¸‹è½½åŸå§‹æ–‡ä»¶</el-button>
                  <el-button type="primary" @click="downloadFile('result')" :disabled="taskDetail.status!=='success'">ä¸‹è½½ç»“æœæ–‡ä»¶</el-button>
                  <el-button @click="downloadFile('diff')" :disabled="taskDetail.status!=='success'">ä¸‹è½½å¯¹æ¯”æ–‡ä»¶</el-button>
                </div>
                <div class="footer-note">
                  ä¸€æœŸï¼šä¸‹è½½ä¸åšé¢å¤–é‰´æƒï¼ˆä»…ç™»å½•å³å¯ï¼‰ã€‚å¤„ç†å¤±è´¥æ—¶ä¸æä¾›ç»“æœ/å¯¹æ¯”ã€‚
                </div>

                <el-divider />

                <div v-if="taskDetail.status==='success'">
                  <div class="section-title" style="margin-bottom: 8px;">å˜åŒ–ç»Ÿè®¡</div>
                  <div class="kpi">
                    <div class="box"><div class="label">æ€»è¡Œæ•°</div><div class="value">{{taskDetail.stats.total_rows}}</div></div>
                    <div class="box"><div class="label">ä¿®å¤å­—æ®µæ•°</div><div class="value">{{taskDetail.stats.fixed_count}}</div></div>
                    <div class="box"><div class="label">è¡¥é½å­—æ®µæ•°</div><div class="value">{{taskDetail.stats.filled_count}}</div></div>
                    <div class="box"><div class="label">æ±‡ç‡å˜æ›´è¡Œæ•°</div><div class="value">{{taskDetail.stats.fx_changed_rows}}</div></div>
                    <div class="box"><div class="label">LLMè¡¥é½å­—æ®µæ•°</div><div class="value">{{taskDetail.stats.llm_filled_count}}</div></div>
                  </div>
                </div>

                <div v-else-if="taskDetail.status==='failed'">
                  <div class="section-title" style="margin-bottom: 8px;">å¤±è´¥åŸå› </div>
                  <el-alert type="error" :closable="false"
                    :title="taskDetail.error.message"
                    :description="'é”™è¯¯ç ï¼š'+taskDetail.error.code+'ï¼›ä½ç½®ï¼š'+taskDetail.error.detail.sheet+' R'+taskDetail.error.detail.row+' C'+taskDetail.error.detail.col">
                  </el-alert>
                </div>

                <div v-else>
                  <el-alert type="info" :closable="false" title="ç­‰å¾…å¤„ç†æˆ–å¤„ç†ä¸­" description="processing é˜¶æ®µå¯å±•ç¤ºè¿›åº¦ä¸æ—¥å¿—ï¼ˆä¸€æœŸå¯ç®€åŒ–ï¼‰ã€‚"></el-alert>
                </div>
              </div>
            </div>

            <!-- RIGHT: Config snapshot -->
            <div class="card">
              <div class="card-hd">
                <div>
                  <div class="section-title">å¤„ç†é…ç½®å¿«ç…§ï¼ˆå±•ç¤ºï¼‰</div>
                  <div class="muted">æ¨¡æ¿æ˜ å°„ + MAP + PROCESS + AI èƒ½åŠ›</div>
                </div>
              </div>
              <div class="card-bd">
                <el-collapse accordion>
                  <el-collapse-item title="æ¨¡æ¿æ˜ å°„ï¼ˆtemplate_mappingsï¼‰" name="1">
                    <div class="muted">ç”¨äºè¯†åˆ« Sheetã€ç»‘å®šåŸå§‹åˆ—åˆ° source_key</div>
                    <div style="margin-top:8px;">
                      <el-tag>sheet_match: Sheet1</el-tag>
                      <div class="footer-note">åŸå‹ä¸­ä»…å±•ç¤ºï¼Œä¸åšç¼–è¾‘ã€‚</div>
                    </div>
                  </el-collapse-item>

                  <el-collapse-item title="å­—æ®µæ˜ å°„ï¼ˆMAPï¼‰" name="2">
                    <div class="muted">å®šä¹‰æœ€ç»ˆåˆ—å€¼ä»å“ªé‡Œæ¥ï¼šCOPY/DROP/DERIVE</div>
                    <div class="footer-note">DERIVE å¯èƒ½èµ° AI æˆ–è®¡ç®—ï¼›COPY å–åŸå§‹åˆ—ï¼›DROP ä¸è¾“å‡ºã€‚</div>
                  </el-collapse-item>

                  <el-collapse-item title="å­—æ®µå¤„ç†ï¼ˆPROCESSï¼‰" name="3">
                    <div class="muted">RULE_FIX / CALC / AIï¼Œä¸”ä¾èµ–å…³ç³»ä¸åŒ</div>
                    <div class="footer-note">RULE_FIX ä»…ä¾èµ–è‡ªèº«ï¼›CALC/AI å¯ä¾èµ–å…¶ä»–åˆ—ã€‚</div>
                  </el-collapse-item>

                  <el-collapse-item title="AI èƒ½åŠ›ï¼ˆai_field_capabilitiesï¼‰" name="4">
                    <div class="muted">åˆ—çº§ prompt / çº¦æŸ / å¤±è´¥ç­–ç•¥</div>
                    <div class="footer-note">ç”¨äº PROCESS é˜¶æ®µ field_type=AI çš„æ‰§è¡Œã€‚</div>
                  </el-collapse-item>
                </el-collapse>
              </div>
            </div>
          </div>

          <!-- ADMIN: RULES -->
          <div v-else-if="route==='admin_rules'" class="card">
            <div class="card-hd">
              <div>
                <div class="section-title">è§„åˆ™é…ç½®</div>
                <div class="muted">rule_tables / rule_items Â· æ”¯æŒå¯¼å…¥æ¨¡æ¿</div>
              </div>
              <div style="display:flex; gap:8px;">
                <el-button type="primary" @click="importDialog=true">å¯¼å…¥è§„åˆ™æ¨¡æ¿</el-button>
              </div>
            </div>

            <div class="card-bd">
              <el-table :data="ruleTables" style="width:100%;">
                <el-table-column prop="code" label="code" width="170"></el-table-column>
                <el-table-column prop="file_type" label="file_type" width="120"></el-table-column>
                <el-table-column prop="rule_stage" label="stage" width="120"></el-table-column>
                <el-table-column prop="enabled" label="enabled" width="120">
                  <template #default="{row}">
                    <el-switch v-model="row.enabled"></el-switch>
                  </template>
                </el-table-column>
                <el-table-column prop="description" label="description"></el-table-column>
              </el-table>

              <div class="footer-note">
                åŸå‹ï¼šrule_items çš„å¢åˆ æ”¹æŸ¥å¯åœ¨äºŒçº§é¡µé¢å®Œæˆï¼ˆæ­¤å¤„çœç•¥ï¼‰ã€‚çœŸå®å®ç°å»ºè®®ï¼šæ”¯æŒæŒ‰è¡¨ç­›é€‰ã€ç¼–è¾‘ã€æ’åºã€æ ¡éªŒã€‚
              </div>
            </div>
          </div>

          <!-- ADMIN: TEMPLATES -->
          <div v-else-if="route==='admin_templates'" class="card">
            <div class="card-hd">
              <div>
                <div class="section-title">æ¨¡æ¿æ˜ å°„ï¼ˆtemplate_mappingsï¼‰</div>
                <div class="muted">è§£å†³åŸå§‹ Excel æ¨¡æ¿å·®å¼‚ï¼šSheet è¯†åˆ« + åˆ—ç»‘å®š</div>
              </div>
              <div style="display:flex; gap:8px;">
                <el-button type="primary">æ–°å¢æ˜ å°„</el-button>
              </div>
            </div>
            <div class="card-bd">
              <el-table :data="templateMappings" style="width:100%;">
                <el-table-column prop="mapping_code" label="mapping_code" width="200"></el-table-column>
                <el-table-column prop="file_type" label="file_type" width="120"></el-table-column>
                <el-table-column prop="sheet_match_mode" label="sheet_match_mode" width="150"></el-table-column>
                <el-table-column prop="sheet_match_value" label="sheet_match_value" width="160"></el-table-column>
                <el-table-column prop="enabled" label="enabled" width="120">
                  <template #default="{row}"><el-switch v-model="row.enabled"></el-switch></template>
                </el-table-column>
                <el-table-column label="æ“ä½œ" width="160">
                  <template #default>
                    <el-button size="small">ç¼–è¾‘</el-button>
                    <el-button size="small" type="primary" plain>æ ¡éªŒ</el-button>
                  </template>
                </el-table-column>
              </el-table>
              <div class="footer-note">
                å»ºè®®ç¼–è¾‘é¡µï¼šæ”¯æŒ JSON ç¼–è¾‘å™¨ï¼ˆcolumn_bindings_jsonï¼‰ã€ä¸€é”®æ ¡éªŒ required source_key æ˜¯å¦èƒ½è§£æã€‚
              </div>
            </div>
          </div>

          <!-- ADMIN: AI -->
          <div v-else-if="route==='admin_ai'" class="card">
            <div class="card-hd">
              <div>
                <div class="section-title">AI èƒ½åŠ›é…ç½®ï¼ˆai_field_capabilitiesï¼‰</div>
                <div class="muted">æŒ‰åˆ—é…ç½® capability / depends_on / prompt / è¾“å‡ºçº¦æŸ</div>
              </div>
              <div style="display:flex; gap:8px;">
                <el-button type="primary">æ–°å¢ AI é…ç½®</el-button>
              </div>
            </div>
            <div class="card-bd">
              <el-table :data="aiCaps" style="width:100%;">
                <el-table-column prop="file_type" label="file_type" width="120"></el-table-column>
                <el-table-column prop="target_column" label="target_column" width="140"></el-table-column>
                <el-table-column prop="capability_code" label="capability_code" width="220"></el-table-column>
                <el-table-column prop="depends_on" label="depends_on" width="200"></el-table-column>
                <el-table-column prop="on_fail" label="on_fail" width="120"></el-table-column>
                <el-table-column prop="enabled" label="enabled" width="120">
                  <template #default="{row}"><el-switch v-model="row.enabled"></el-switch></template>
                </el-table-column>
                <el-table-column label="æ“ä½œ" width="160">
                  <template #default>
                    <el-button size="small">ç¼–è¾‘</el-button>
                    <el-button size="small" type="danger" plain>åˆ é™¤</el-button>
                  </template>
                </el-table-column>
              </el-table>
              <div class="footer-note">
                ç¼–è¾‘é¡µåº”åŒ…å«ï¼šprompt_templateã€å¤šè¯­è¨€ã€output_constraints_jsonï¼ˆmax_length/charset/not_emptyï¼‰ã€‚
              </div>
            </div>
          </div>

          <!-- ADMIN: USERS -->
          <div v-else-if="route==='admin_users'" class="card">
            <div class="card-hd">
              <div>
                <div class="section-title">ç”¨æˆ·ç®¡ç†</div>
                <div class="muted">åˆ›å»ºç”¨æˆ·ã€å¯ç”¨/ç¦ç”¨ã€é‡ç½®å¯†ç </div>
              </div>
              <div style="display:flex; gap:8px;">
                <el-button type="primary">æ–°å¢ç”¨æˆ·</el-button>
              </div>
            </div>
            <div class="card-bd">
              <el-table :data="users" style="width:100%;">
                <el-table-column prop="username" label="username" width="180"></el-table-column>
                <el-table-column prop="display_name" label="display_name" width="180"></el-table-column>
                <el-table-column prop="role" label="role" width="140">
                  <template #default="{row}">
                    <el-tag v-if="row.role==='admin'" type="warning">admin</el-tag>
                    <el-tag v-else>operator</el-tag>
                  </template>
                </el-table-column>
                <el-table-column prop="enabled" label="enabled" width="140">
                  <template #default="{row}"><el-switch v-model="row.enabled"></el-switch></template>
                </el-table-column>
                <el-table-column label="æ“ä½œ" width="220">
                  <template #default>
                    <el-button size="small">é‡ç½®å¯†ç </el-button>
                    <el-button size="small" type="danger" plain>åˆ é™¤</el-button>
                  </template>
                </el-table-column>
              </el-table>
            </div>
          </div>

          <!-- ADMIN: LOGS -->
          <div v-else-if="route==='admin_logs'" class="card">
            <div class="card-hd">
              <div>
                <div class="section-title">æ“ä½œæ—¥å¿—</div>
                <div class="muted">ç™»å½• / åˆ›å»ºä»»åŠ¡ / æˆåŠŸå¤±è´¥ / é…ç½®å˜æ›´</div>
              </div>
            </div>
            <div class="card-bd">
              <el-table :data="logs" style="width:100%;">
                <el-table-column prop="created_at" label="time" width="200"></el-table-column>
                <el-table-column prop="user" label="user" width="120"></el-table-column>
                <el-table-column prop="action" label="action" width="180"></el-table-column>
                <el-table-column prop="entity" label="entity" width="160"></el-table-column>
                <el-table-column prop="success" label="success" width="120">
                  <template #default="{row}">
                    <el-tag v-if="row.success" type="success">true</el-tag>
                    <el-tag v-else type="danger">false</el-tag>
                  </template>
                </el-table-column>
                <el-table-column prop="message" label="message"></el-table-column>
              </el-table>
              <div class="footer-note">
                ä¸€æœŸå»ºè®®ï¼šæ—¥å¿—åªè¯»ï¼›äºŒæœŸå¯å¢åŠ ç­›é€‰ä¸å¯¼å‡ºã€‚
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Create Task Dialog -->
      <el-dialog v-model="createDialog" title="æ–°å»ºä»»åŠ¡ï¼ˆä¸Šä¼  Excelï¼‰" width="720px">
        <el-form label-position="top">
          <div class="grid-2">
            <el-form-item label="æ–‡ä»¶ç±»å‹">
              <el-select v-model="createForm.file_type" style="width:100%;">
                <el-option label="æ¸…å…³æ–‡ä»¶" value="customs"></el-option>
                <el-option label="æ´¾é€æ–‡ä»¶" value="delivery"></el-option>
              </el-select>
            </el-form-item>
            <el-form-item label="å”¯ä¸€ç¼–ç ï¼ˆå¿…å¡«ï¼‰">
              <el-input v-model="createForm.unique_code" placeholder="ä¾‹å¦‚ UC001"></el-input>
            </el-form-item>
          </div>

          <div v-if="createForm.file_type==='customs'" class="grid-2">
            <el-form-item label="èˆªç©ºå·ï¼ˆå¿…å¡«ï¼‰">
              <el-input v-model="createForm.flight_no" placeholder="ä¾‹å¦‚ NH123"></el-input>
            </el-form-item>
            <el-form-item label="æŠ¥å…³æ—¥æœŸï¼ˆå¿…å¡«ï¼‰">
              <el-date-picker v-model="createForm.declare_date" type="date" value-format="YYYY-MM-DD" style="width:100%;"></el-date-picker>
            </el-form-item>
          </div>

          <el-form-item label="ä¸Šä¼ æ–‡ä»¶ï¼ˆä»…æ”¯æŒ .xlsxï¼Œä¸”ä¸€æ¬¡ä»… 1 ä¸ªæ–‡ä»¶ï¼‰">
            <el-upload
              drag
              :auto-upload="false"
              :limit="1"
              accept=".xlsx"
              :on-change="(file)=>handleFileChange(file)"
            >
              <i class="el-icon-upload"></i>
              <div class="el-upload__text">æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„ï¼Œæˆ– <em>ç‚¹å‡»é€‰æ‹©</em></div>
              <template #tip>
                <div class="el-upload__tip">åŸå‹ï¼šä»…é€‰æ‹©æ–‡ä»¶ï¼Œä¸ä¼šçœŸå®ä¸Šä¼ </div>
              </template>
            </el-upload>
          </el-form-item>

          <el-alert type="info" :closable="false"
            title="å¤„ç†é€»è¾‘æç¤º"
            description="ç³»ç»Ÿå°†æŒ‰ï¼šæ¨¡æ¿æ˜ å°„(template_mappings) â†’ å­—æ®µæ˜ å°„(MAP) â†’ å­—æ®µå¤„ç†(PROCESSï¼šRULE_FIX/CALC/AI) â†’ æ ·å¼(ExcelConfig) ç”Ÿæˆæœ€ç»ˆæ–‡ä»¶ã€‚">
          </el-alert>
        </el-form>

        <template #footer>
          <el-button @click="createDialog=false">å–æ¶ˆ</el-button>
          <el-button type="primary" @click="submitCreate">åˆ›å»ºä»»åŠ¡</el-button>
        </template>
      </el-dialog>

      <!-- Import Dialog -->
      <el-dialog v-model="importDialog" title="å¯¼å…¥è§„åˆ™é…ç½®ï¼ˆExcel æ¨¡æ¿ï¼‰" width="720px">
        <el-upload
          drag
          :auto-upload="false"
          :limit="1"
          accept=".xlsx"
          :on-change="(file)=>onImportChange(file)"
        >
          <div class="el-upload__text">æ‹–æ‹½å¯¼å…¥æ¨¡æ¿åˆ°æ­¤å¤„ï¼Œæˆ– <em>ç‚¹å‡»é€‰æ‹©</em></div>
        </el-upload>

        <div class="footer-note">
          åŸå‹ï¼šå¯¼å…¥å°†å†™å…¥ rule_tables / rule_items / template_mappings / ai_field_capabilitiesï¼ˆçœŸå®å®ç°éœ€åç«¯æ ¡éªŒï¼‰ã€‚
        </div>

        <template #footer>
          <el-button @click="importDialog=false">å–æ¶ˆ</el-button>
          <el-button type="primary" @click="doImport">å¼€å§‹å¯¼å…¥</el-button>
        </template>
      </el-dialog>
    </div>
  </div>
  `
}).use(ElementPlus).mount("#app");
</script>
</body>
</html>
