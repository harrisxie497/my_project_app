ä¸‹é¢æ˜¯**åŸºäºæˆ‘ä»¬æˆªè‡³ç›®å‰å…¨éƒ¨å…±è¯†**ï¼Œé‡æ–°æ•´ç†ã€ç»“æ„åŒ–ã€å†»ç»“çš„ä¸€ä»½ **å®Œæ•´ PRDï¼ˆå« DB è®¾è®¡ï¼‰**ã€‚
è¿™æ˜¯ä¸€ä»½**å¯ä»¥ç›´æ¥äº¤ä»˜ç»™ç ”å‘/è¯„å®¡/ç«‹é¡¹çš„ç‰ˆæœ¬**ï¼Œé€»è¾‘å·²ç»â€œæ”¶æ•›â€ï¼Œä¸ä¼šå†å‡ºç°ä¸­é€”æ¨ç¿»çš„ç‚¹ã€‚

> **PRD v1.0ï¼ˆé‡æ„å†»ç»“ç‰ˆï¼‰**
> èŒƒå›´ï¼šä¸€æœŸå®ç° + äºŒæœŸå±•æœ›
> å…³é”®è¯ï¼š**æ— ä¸­é—´è¡¨ã€è§„åˆ™é©±åŠ¨ã€åˆ—çº§ä¸šåŠ¡è§„åˆ™ã€æ¨¡æ¿æ˜ å°„ã€AI èƒ½åŠ›é…ç½®**

---

# æ—¥æœ¬æ¸…å…³ / æ´¾é€ Excel è‡ªåŠ¨å¤„ç†ç³»ç»Ÿ

**PRD v1.0ï¼ˆä¸€æœŸå†»ç»“ç‰ˆï¼‰**

---

## 1. èƒŒæ™¯ä¸ç›®æ ‡

### 1.1 èƒŒæ™¯

æ—¥æœ¬æ¸…å…³ä¸æ´¾é€ä¸šåŠ¡ä¸­ï¼ŒExcel æ–‡ä»¶å¤„ç†å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š

* åŸå§‹ Excel æ¥æºå¤šã€æ¨¡æ¿ä¸ç»Ÿä¸€
* å­—æ®µè§„åˆ™å¤æ‚ï¼Œäººå·¥ä¿®å¤æˆæœ¬é«˜
* éƒ¨åˆ†å­—æ®µéœ€è®¡ç®—ï¼Œéƒ¨åˆ†å­—æ®µéœ€ AI è¯­ä¹‰è¡¥é½
* è¾“å‡º Excel å¯¹å­—ä½“ã€æ ·å¼ã€åˆå¹¶å•å…ƒæ ¼æœ‰ä¸¥æ ¼è¦æ±‚
* å¤„ç†è¿‡ç¨‹ç¼ºä¹ç»“æ„åŒ–è§„åˆ™ä¸å¯è¿½æº¯æ€§

---

### 1.2 äº§å“ç›®æ ‡

æ„å»ºä¸€ä¸ª Web ç³»ç»Ÿï¼Œå®ç°ï¼š

1. ç”¨æˆ·ä¸Šä¼  **åŸå§‹ Excel æ–‡ä»¶**
2. ç³»ç»ŸåŸºäº **è§„åˆ™é…ç½®**ï¼š

   * æ˜ å°„åŸå§‹å­—æ®µåˆ°æœ€ç»ˆå­—æ®µ
   * æ‰§è¡Œå­—æ®µçº§ä¿®å¤ / è®¡ç®— / AI ç”Ÿæˆ
3. ç”Ÿæˆ **æœ€ç»ˆåˆè§„ Excel**
4. è¾“å‡º **åŸå§‹æ–‡ä»¶ / ç»“æœæ–‡ä»¶ / å¯¹æ¯”æ–‡ä»¶**
5. æä¾› **ä»»åŠ¡å†å²ä¸æ“ä½œæ—¥å¿—**

---

## 2. ç”¨æˆ·è§’è‰²ä¸æƒé™ï¼ˆä¸€æœŸï¼‰

### 2.1 ç”¨æˆ·è§’è‰²

| è§’è‰²  | èƒ½åŠ›        |
| --- | --------- |
| ç®¡ç†å‘˜ | ç”¨æˆ·ç®¡ç†ã€è§„åˆ™é…ç½® |
| æ“ä½œå‘˜ | ä¸Šä¼ æ–‡ä»¶ã€æ‰§è¡Œå¤„ç† |

---

### 2.2 æƒé™ç­–ç•¥ï¼ˆä¸€æœŸå†»ç»“ï¼‰

* ç³»ç»Ÿå¿…é¡»ç™»å½•ä½¿ç”¨
* **ä¸åšç”¨æˆ·çº§æ•°æ®éš”ç¦»**
* **ä¸åšä¸‹è½½é‰´æƒ**
* ç®¡ç†å‘˜æƒé™ä»…ä½“ç°åœ¨é…ç½®åŠŸèƒ½å…¥å£

---

## 3. æ–‡ä»¶ç±»å‹ä¸è¾“å…¥è§„åˆ™ï¼ˆä¸€æœŸï¼‰

### 3.1 æ”¯æŒçš„æ–‡ä»¶ç±»å‹

| æ–‡ä»¶ç±»å‹ | æ ‡è¯†         |
| ---- | ---------- |
| æ¸…å…³æ–‡ä»¶ | `customs`  |
| æ´¾é€æ–‡ä»¶ | `delivery` |

---

### 3.2 ä¸Šä¼ è§„åˆ™

* ä¸€æ¬¡ä»…æ”¯æŒ **1 ä¸ª Excel æ–‡ä»¶**
* æ–‡ä»¶æ ¼å¼ï¼š`.xlsx`
* æ”¯æŒå¤š Sheetï¼š

  * ä»… 1 ä¸ª Sheet å‚ä¸å¤„ç†
  * å…¶ä½™ Sheet åŸæ ·å¤åˆ¶
* æ”¯æŒåˆå¹¶å•å…ƒæ ¼

---

### 3.3 ä¸šåŠ¡è¾“å…¥å­—æ®µ

#### æ¸…å…³æ–‡ä»¶ï¼ˆcustomsï¼‰

* èˆªç©ºå·ï¼ˆflight_noï¼‰
* æŠ¥å…³æ—¥æœŸï¼ˆdeclare_dateï¼‰
* å”¯ä¸€ç¼–ç ï¼ˆunique_codeï¼‰

#### æ´¾é€æ–‡ä»¶ï¼ˆdeliveryï¼‰

* å”¯ä¸€ç¼–ç ï¼ˆunique_codeï¼‰

---

## 4. ç³»ç»Ÿå¤„ç†æµç¨‹ï¼ˆä¸€æœŸï¼‰

```text
åŸå§‹ Excel
   â”‚
   â”‚ â‘  æ¨¡æ¿æ˜ å°„ï¼ˆtemplate_mappingsï¼‰
   â”‚    - è¯†åˆ« Sheet
   â”‚    - åŸå§‹åˆ— â†’ source_key
   â”‚
   â”‚ â‘¡ å­—æ®µæ˜ å°„ï¼ˆMAP è§„åˆ™ï¼‰
   â”‚    - åŸå§‹ â†’ æœ€ç»ˆå­—æ®µæ¥æº
   â”‚
   â”‚ â‘¢ å­—æ®µå¤„ç†ï¼ˆPROCESS è§„åˆ™ï¼‰
   â”‚    - RULE_FIX / CALC / AI
   â”‚
   â”‚ â‘£ Excel æ ·å¼åº”ç”¨ï¼ˆExcelConfigï¼‰
   â”‚
   â–¼
æœ€ç»ˆ Excel + å¯¹æ¯”æ–‡ä»¶ + ç»Ÿè®¡
```

> ä»»ä¸€æ­¥å¤±è´¥ â†’ **ä»»åŠ¡æ•´ä½“å¤±è´¥ï¼ˆé˜»æ–­ï¼‰**

---

## 5. è§„åˆ™ä½“ç³»ï¼ˆæ ¸å¿ƒè®¾è®¡ï¼‰

ç³»ç»Ÿé‡‡ç”¨ **è§„åˆ™é©±åŠ¨æ¶æ„**ï¼Œè§„åˆ™åˆ†ä¸ºä¸‰ç±»é…ç½®ï¼Œä½†èŒè´£æ¸…æ™°ã€ä¸æ··ç”¨ã€‚

---

## 5.1 æ¨¡æ¿æ˜ å°„è§„åˆ™ï¼ˆTemplate Mappingï¼‰

### ç›®çš„

è§£å†³ï¼š

* åŸå§‹ Excel åˆ—é¡ºåºå˜åŒ–
* åˆ—æ ‡é¢˜ä¸ä¸€è‡´
* å¤šæ¥æºæ¨¡æ¿å·®å¼‚

### èƒ½åŠ›

* é€šè¿‡ **Sheet å / ç´¢å¼•**è¯†åˆ«ç›®æ ‡ Sheet
* é€šè¿‡ **è¡¨å¤´åˆ«å / ä½ç½®å…œåº•** ç»‘å®šåŸå§‹åˆ—
* å°†åŸå§‹åˆ—ç»‘å®šä¸ºç³»ç»Ÿå†…éƒ¨ `source_key`

---

## 5.2 å­—æ®µæ˜ å°„è§„åˆ™ï¼ˆMAPï¼‰

### ç›®çš„

å®šä¹‰ **æœ€ç»ˆ Excel çš„æ¯ä¸€åˆ—ï¼Œå…¶å€¼ä»å“ªé‡Œæ¥**

### æ“ä½œç±»å‹

| æ“ä½œ     | å«ä¹‰        |
| ------ | --------- |
| COPY   | ä»åŸå§‹åˆ—ç›´æ¥å¤åˆ¶  |
| DROP   | æœ€ç»ˆæ–‡ä»¶ä¸ä¿ç•™è¯¥åˆ— |
| DERIVE | ä»å¤šä¸ªå­—æ®µç”Ÿæˆ   |

---

## 5.3 å­—æ®µå¤„ç†è§„åˆ™ï¼ˆPROCESSï¼‰

å­—æ®µçº§ä¸šåŠ¡è§„åˆ™ï¼Œ**æŒ‰åˆ—å®šä¹‰**ã€‚

### å­—æ®µç±»å‹ï¼ˆå¿…é¡»æ ‡æ³¨ï¼‰

| ç±»å‹       | å«ä¹‰           | ä¾èµ–     |
| -------- | ------------ | ------ |
| RULE_FIX | è§„åˆ™æ ¡éªŒå¹¶ä¿®æ­£      | ä»…è‡ªèº«    |
| CALC     | è®¡ç®—å­—æ®µ         | ä¾èµ–å…¶ä»–å­—æ®µ |
| AI       | AI è¯­ä¹‰ç”Ÿæˆ / ä¿®æ­£ | ä¾èµ–å¤šä¸ªå­—æ®µ |

### æ‰§è¡Œé¡ºåºï¼ˆä¸€æœŸå†™æ­»ï¼‰

1. RULE_FIX
2. CALC
3. AI

---

## 5.4 AI èƒ½åŠ›é…ç½®ï¼ˆåˆ—çº§ï¼‰

AI ç›¸å…³èƒ½åŠ› **ä¸å†™æ­»åœ¨è§„åˆ™é‡Œ**ï¼Œç»Ÿä¸€é…ç½®ï¼š

* ä½¿ç”¨å“ªç§èƒ½åŠ›
* prompt æ¨¡æ¿
* ä¾èµ–å­—æ®µ
* è¾“å‡ºçº¦æŸ
* å¤±è´¥ç­–ç•¥

---

## 6. Excel è¾“å‡ºè§„èŒƒï¼ˆä¸€æœŸå†»ç»“ï¼‰

### 6.1 å­—ä½“

* é»˜è®¤å­—ä½“ï¼š**å¯é…ç½®**
* æ‰€æœ‰å†™å…¥/ä¿®æ”¹çš„å•å…ƒæ ¼å¿…é¡»ä½¿ç”¨é»˜è®¤å­—ä½“

### 6.2 æ—¥æœŸä¸æ•°å€¼

* æ—¥æœŸç»Ÿä¸€ï¼š`YYYY-MM-DD`
* ä¸å‡ºç°ç§‘å­¦è®¡æ•°æ³•
* æ–‡æœ¬ä¿ç•™å‰å¯¼é›¶

### 6.3 åˆå¹¶å•å…ƒæ ¼

* åˆå¹¶èŒƒå›´ç”±é…ç½®æŒ‡å®š
* ä¸è‡ªåŠ¨æ¨æ–­

### 6.4 æ ·å¼

* æ ·å¼ä¸º **æ¨¡æ¿çº§å›ºå®šè¡¨ç°**
* å¯æŒ‰åˆ—/è¡Œ/èŒƒå›´é…ç½®ï¼ˆå¦‚ï¼šB åˆ—æ ‡é»„ï¼‰

---

## 7. è¾“å‡ºç‰©ï¼ˆä¸€æœŸï¼‰

| è¾“å‡º       | å¿…é¡» |
| -------- | -- |
| åŸå§‹ Excel | âœ…  |
| æœ€ç»ˆ Excel | âœ…  |
| å¯¹æ¯” Excel | âœ…  |

### å¯¹æ¯”å†…å®¹

* Sheet
* è¡Œ / åˆ—
* åŸå€¼ / æ–°å€¼
* å˜åŒ–ç±»å‹

---

## 8. ä»»åŠ¡ä¸æ—¥å¿—

### 8.1 ä»»åŠ¡

* ä¸€ä¸ªä»»åŠ¡ = ä¸€ä¸ª Excel
* çŠ¶æ€ï¼šprocessing / success / failed
* è®°å½•å‚æ•°ã€æ–‡ä»¶è·¯å¾„ã€ç»Ÿè®¡ã€é”™è¯¯ä¿¡æ¯

### 8.2 æ“ä½œæ—¥å¿—

* ç™»å½•æˆåŠŸ / å¤±è´¥
* åˆ›å»ºä»»åŠ¡
* ä»»åŠ¡æˆåŠŸ / å¤±è´¥
* ï¼ˆå¯é€‰ï¼‰æ–‡ä»¶ä¸‹è½½

---

# 9. æ•°æ®åº“è®¾è®¡ï¼ˆä¸€æœŸå†»ç»“ï¼‰

---

## 9.1 users

| å­—æ®µ                      |
| ----------------------- |
| id                      |
| username (unique)       |
| password_hash           |
| display_name            |
| role (admin/operator)   |
| enabled                 |
| last_login_at           |
| created_at / updated_at |

---

## 9.2 tasks

| å­—æ®µ                                             |
| ---------------------------------------------- |
| id                                             |
| created_by_user_id                             |
| file_type                                      |
| unique_code                                    |
| flight_no                                      |
| declare_date                                   |
| status                                         |
| error_code / error_message / error_detail_json |
| stats_json                                     |
| started_at / finished_at                       |
| created_at / updated_at                        |

---

## 9.3 task_files

| å­—æ®µ                               |
| -------------------------------- |
| id                               |
| task_id                          |
| original_file_name / storage_key |
| result_file_name / storage_key   |
| diff_file_name / storage_key     |
| mime_type                        |
| size_bytes                       |
| created_at / updated_at          |

---

## 9.4 rule_tables

| å­—æ®µ                           |
| ---------------------------- |
| id                           |
| code (unique)                |
| file_type (customs/delivery) |
| rule_stage (MAP/PROCESS)     |
| enabled                      |
| description                  |
| created_at / updated_at      |

---

## 9.5 rule_items

| å­—æ®µ                                |
| --------------------------------- |
| id                                |
| rule_table_id                     |
| enabled                           |
| order_no                          |
| target_column                     |
| target_field_name                 |
| map_op / source_column / derive_* |
| field_type                        |
| process_depends_on                |
| process_rules_json                |
| executor                          |
| on_fail                           |
| note                              |
| created_at / updated_at           |

---

## 9.6 template_mappings

| å­—æ®µ                      |
| ----------------------- |
| id                      |
| mapping_code            |
| file_type               |
| source_template_code    |
| target_template_code    |
| sheet_match_mode        |
| sheet_match_value       |
| column_bindings_json    |
| enabled                 |
| created_at / updated_at |

---

## 9.7 ai_field_capabilities

| å­—æ®µ                      |
| ----------------------- |
| id                      |
| file_type               |
| target_column           |
| capability_code         |
| depends_on              |
| prompt_template         |
| output_constraints_json |
| on_fail                 |
| enabled                 |
| created_at / updated_at |

---

## 9.8 operation_logs

| å­—æ®µ                      |
| ----------------------- |
| id                      |
| user_id                 |
| action                  |
| entity_type / entity_id |
| success                 |
| message                 |
| detail_json             |
| created_at              |

---

## 10. äºŒæœŸè§„åˆ’ï¼ˆä¸å½±å“ä¸€æœŸï¼‰

* æ‰¹é‡æ–‡ä»¶ä¸Šä¼ 
* æ–‡ä»¶çº§æˆåŠŸ/å¤±è´¥
* å˜åŒ–é«˜äº®ï¼ˆdiff é«˜äº®ï¼‰
* Web ç«¯å·®å¼‚é¢„è§ˆ
* è§„åˆ™ç‰ˆæœ¬ç®¡ç†
* ä¸‹è½½é‰´æƒ / è„±æ•

---

## 11. å½“å‰çŠ¶æ€

* âœ… PRD å·²å†»ç»“
* âœ… DB ç»“æ„å·²ç¡®å®š
* âœ… è§„åˆ™æ¨¡å‹å·²ç»Ÿä¸€
* ğŸš€ å¯ç›´æ¥è¿›å…¥ï¼š

  * æ¥å£è®¾è®¡
  * åç«¯å®ç°
  * è§„åˆ™å¡«è¡¨

---

å¦‚æœä½ æ„¿æ„ï¼Œ**ä¸‹ä¸€æ­¥æœ€è‡ªç„¶çš„æ˜¯**ï¼š

ğŸ‘‰ **åŸºäºè¿™ä»½ PRDï¼Œç›´æ¥ç”Ÿæˆ FastAPI æ¥å£è®¾è®¡æ–‡æ¡£ï¼ˆAPI Specï¼‰**
ğŸ‘‰ æˆ– **æŠŠ PDF çš„ 3.4 å…¨é‡è½¬æˆ rule_items å®ä¾‹è¡¨**

ä½ åªéœ€è¯´ä¸‹ä¸€æ­¥è¦å“ªä¸€ä¸ªã€‚
